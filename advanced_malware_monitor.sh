#!/bin/bash
# Advanced Malware Monitor with Source Detection
# This script monitors for malware and identifies how it's being executed

LOG_FILE="/var/log/malware_monitor_detailed.log"
ALERT_FILE="/var/log/malware_alerts.log"

echo "========================================" | sudo tee -a $LOG_FILE
echo "Advanced Malware Monitor Started: $(date)" | sudo tee -a $LOG_FILE
echo "========================================" | sudo tee -a $LOG_FILE

while true; do
    # Check for processes in /dev/shm
    MALWARE_PROCS=$(ps aux | grep '/dev/shm/' | grep -v grep)
    
    if [ ! -z "$MALWARE_PROCS" ]; then
        echo "" | sudo tee -a $ALERT_FILE
        echo "!!! MALWARE DETECTED AT $(date) !!!" | sudo tee -a $ALERT_FILE
        echo "========================================" | sudo tee -a $ALERT_FILE
        
        # Log the malware processes
        echo "$MALWARE_PROCS" | sudo tee -a $ALERT_FILE
        
        # Get PIDs
        MALWARE_PIDS=$(echo "$MALWARE_PROCS" | awk '{print $2}')
        
        for PID in $MALWARE_PIDS; do
            echo "" | sudo tee -a $ALERT_FILE
            echo "Analyzing PID: $PID" | sudo tee -a $ALERT_FILE
            echo "---" | sudo tee -a $ALERT_FILE
            
            # Get parent process
            PPID=$(ps -o ppid= -p $PID 2>/dev/null | tr -d ' ')
            echo "Parent PID: $PPID" | sudo tee -a $ALERT_FILE
            
            if [ ! -z "$PPID" ]; then
                echo "Parent process info:" | sudo tee -a $ALERT_FILE
                ps -fp $PPID 2>/dev/null | sudo tee -a $ALERT_FILE
            fi
            
            # Get process tree
            echo "Process tree:" | sudo tee -a $ALERT_FILE
            pstree -p $PID 2>/dev/null | sudo tee -a $ALERT_FILE
            
            # Get command line
            echo "Command line:" | sudo tee -a $ALERT_FILE
            cat /proc/$PID/cmdline 2>/dev/null | tr '\0' ' ' | sudo tee -a $ALERT_FILE
            echo "" | sudo tee -a $ALERT_FILE
            
            # Get environment variables
            echo "Environment (first 20 lines):" | sudo tee -a $ALERT_FILE
            sudo cat /proc/$PID/environ 2>/dev/null | tr '\0' '\n' | head -20 | sudo tee -a $ALERT_FILE
            
            # Get open files
            echo "Open files:" | sudo tee -a $ALERT_FILE
            sudo lsof -p $PID 2>/dev/null | head -20 | sudo tee -a $ALERT_FILE
            
            # Get network connections
            echo "Network connections:" | sudo tee -a $ALERT_FILE
            sudo netstat -antp 2>/dev/null | grep $PID | sudo tee -a $ALERT_FILE
            
            echo "---" | sudo tee -a $ALERT_FILE
            
            # Kill the process
            echo "Killing PID: $PID" | sudo tee -a $ALERT_FILE
            sudo kill -9 $PID
        done
        
        # List files in /dev/shm before cleaning
        echo "" | sudo tee -a $ALERT_FILE
        echo "Files in /dev/shm before cleaning:" | sudo tee -a $ALERT_FILE
        sudo ls -lah /dev/shm/ | sudo tee -a $ALERT_FILE
        
        # Get file hashes for analysis
        echo "File hashes:" | sudo tee -a $ALERT_FILE
        sudo md5sum /dev/shm/* 2>/dev/null | sudo tee -a $ALERT_FILE
        
        # Clean /dev/shm
        echo "Cleaning /dev/shm..." | sudo tee -a $ALERT_FILE
        sudo rm -rf /dev/shm/*
        
        echo "========================================" | sudo tee -a $ALERT_FILE
        
        # Check what's downloading/creating these files
        echo "Checking for download processes:" | sudo tee -a $ALERT_FILE
        ps aux | grep -iE 'curl|wget|http' | grep -v grep | sudo tee -a $ALERT_FILE
        
        # Check recent network activity
        echo "Recent network connections:" | sudo tee -a $ALERT_FILE
        sudo netstat -antp 2>/dev/null | grep ESTABLISHED | sudo tee -a $ALERT_FILE
    fi
    
    # Check for high CPU processes
    HIGH_CPU=$(ps aux --sort=-%cpu | awk 'NR>1 && $3>70 {print $2,$3,$11}')
    if [ ! -z "$HIGH_CPU" ]; then
        echo "[$(date)] High CPU detected: $HIGH_CPU" | sudo tee -a $LOG_FILE
    fi
    
    # Check for suspicious process names
    SUSPICIOUS=$(ps aux | grep -iE 'xmrig|minerd|cpuminer|cryptonight|kdevtmpfsi|kinsing' | grep -v grep)
    if [ ! -z "$SUSPICIOUS" ]; then
        echo "[$(date)] Suspicious process: $SUSPICIOUS" | sudo tee -a $ALERT_FILE
        SUSP_PIDS=$(echo "$SUSPICIOUS" | awk '{print $2}')
        for PID in $SUSP_PIDS; do
            sudo kill -9 $PID
        done
    fi
    
    # Sleep for 10 seconds (faster detection)
    sleep 10
done












