# راهنمای عیب‌یابی موجودی کیف پول

## ✅ تایید شده: API کار می‌کند!

تست‌ها نشان می‌دهند که:
- ✅ Backend کاملاً کار می‌کند
- ✅ موجودی در دیتابیس ذخیره می‌شود  
- ✅ API endpoint‌ها صحیح هستند

## 🔍 چرا موجودی 0 نشان می‌دهد؟

### احتمال 1: شماره تلفن اشتباه ⭐ (احتمال بالا)

شما ممکن است با کاربری **متفاوت** از کاربری که موجودیش را تغییر داده‌اید، لاگین کرده باشید!

**راه حل:**
1. در پنل ادمین، بخش **کاربران** را باز کنید
2. شماره تلفنی که موجودی به آن اضافه کردید را **یادداشت کنید**
3. از حساب فعلی **خارج شوید** (Logout)
4. با **همان شماره تلفن** دوباره لاگین کنید
5. به صفحه کیف پول بروید

### احتمال 2: Cache مرورگر

**راه حل:**
1. صفحه را با `Ctrl+Shift+R` رفرش سخت کنید
2. یا Developer Tools را باز کنید (F12)
3. Network tab → Disable cache را تیک بزنید
4. صفحه را reload کنید

### احتمال 3: Frontend refresh نمی‌کند

**راه حل:**
1. Frontend را restart کنید:
   ```bash
   cd frontend
   # Ctrl+C to stop
   npm run dev
   ```

## 🧪 تست گام به گام

### مرحله 1: پیدا کردن شماره تلفن کاربر

```bash
python test_user_wallet_view.py
```

این اسکریپت لیست کاربران با موجودی را نشان می‌دهد.

### مرحله 2: افزودن موجودی به کاربر خاص

1. به پنل ادمین بروید: `http://localhost:3000/admin-full`
2. بخش **کاربران** را باز کنید
3. شماره تلفن کاربری که می‌خواهید تست کنید را پیدا کنید
4. روی دکمه **تنظیم** کلیک کنید
5. مقدار موجودی را وارد کنید (مثلاً `50000`)
6. ذخیره کنید

### مرحله 3: تایید در مرورگر (Console)

1. در صفحه ادمین، F12 را بزنید
2. Console tab را باز کنید
3. دوباره موجودی را تغییر دهید
4. باید پیام زیر را ببینید:
   ```
   ✅ Coins updated successfully: { coins: 50000, user_id: X, message: "..." }
   ```

### مرحله 4: بررسی در پروفایل کاربر

1. **خارج شوید** از حساب فعلی
2. با شماره تلفنی که موجودیش را تغییر دادید **لاگین کنید**
3. به `http://localhost:3000/profile/wallet` بروید
4. باید موجودی جدید را ببینید

## 📋 چک لیست نهایی

- [ ] Backend در حال اجرا است (port 8001)
- [ ] Frontend در حال اجرا است (port 3000)
- [ ] در پنل ادمین، موجودی کاربر تغییر کرده
- [ ] شماره تلفن کاربری که موجودیش تغییر کرده را یادداشت کرده‌ام
- [ ] از حساب قبلی خارج شده‌ام (Logout)
- [ ] با همان شماره تلفن دوباره لاگین کرده‌ام
- [ ] Cache مرورگر را پاک کرده‌ام (Ctrl+Shift+R)
- [ ] در Console مرورگر خطایی نیست

## 🎯 تست سریع (5 دقیقه)

```bash
# 1. تست API
python test_coins_api.py

# 2. بررسی کاربران با موجودی
python test_user_wallet_view.py

# 3. یادداشت کردن شماره تلفن کاربر ID=1
# شماره: 09464634646
# موجودی فعلی: 150,000 تومان

# 4. لاگین با این شماره در مرورگر
# 5. رفتن به /profile/wallet
# 6. باید 150,000 تومان را ببینید
```

## 🐛 اگر هنوز کار نکرد...

### دیباگ Frontend

1. صفحه wallet را باز کنید
2. F12 → Console
3. این کد را اجرا کنید:
   ```javascript
   // بررسی user context
   console.log('Current user:', localStorage.getItem('user'));
   
   // دریافت موجودی از API
   fetch('http://localhost:8001/api/auth/me', {
     credentials: 'include'
   })
   .then(r => r.json())
   .then(d => console.log('User from API:', d));
   ```

4. بررسی کنید که:
   - `user_id` صحیح است
   - `coins` در response وجود دارد

### دیباگ Backend

بررسی لاگ‌ها:
```bash
# آخرین 50 خط لاگ
tail -50 backend/logs/app.log

# یا در Windows:
Get-Content backend\logs\app.log -Tail 50
```

### اگر مشکل حل نشد

لطفاً این اطلاعات را ارسال کنید:
1. شماره تلفنی که با آن لاگین کرده‌اید
2. Screenshot از صفحه کیف پول
3. Screenshot از Console مرورگر (F12)
4. Screenshot از بخش کاربران در پنل ادمین که موجودی کاربر را نشان می‌دهد

## ✅ راه حل قطعی

اگر همه چیز گیج شد:

1. **در پنل ادمین**:
   - شماره تلفن خودتان را پیدا کنید
   - موجودی را به `100000` تنظیم کنید
   - ID کاربر را یادداشت کنید

2. **Logout کامل**:
   - از حساب خارج شوید
   - Cache مرورگر را پاک کنید
   - مرورگر را ببندید و دوباره باز کنید

3. **Login دوباره**:
   - با شماره تلفنی که موجودیش `100000` شده لاگین کنید
   - به `/profile/wallet` بروید
   - باید `100,000` تومان را ببینید

---

**تاریخ:** 2025-10-06  
**وضعیت تست:** ✅ API کار می‌کند | Backend صحیح است | موجودی در DB ذخیره می‌شود

