# ุฑุงูููุง ุฑูุน ูุดฺฉู ููุงุด ุงุทูุงุนุงุช ฺฏุฑูู ุฎุฑุฏ

## ๐ ุชุดุฎุต ูุดฺฉู

ูุดฺฉู ฺฏุฒุงุฑุด ุดุฏู:
- ุตูุญู `landingM`: ุงุทูุงุนุงุช ุณุจุฏ ู ุฒูุงู ุจุงููุงูุฏู ูุดูู ููุฏู
- ุตูุญู `track`: ููู ฺ ุตูุฑู
- ุตูุญู `invite`: ุฒูุงู ุจุงููุงูุฏู 0 ูุณุช ุงุฒ ุงูู

## ๐ฏ ุนูุช ูุดฺฉู

ูุดฺฉู ุงุฒ ุงู ุจุงุจุช ุงุณุช ฺฉู ฺฏุฑููโูุง ุฎุฑุฏ ูุฏู (ฺฉู ูุจู ุงุฒ ุงุถุงูู ุดุฏู ููุฏ `basket_snapshot` ุงุฌุงุฏ ุดุฏูุฏ) ุงู ุงุทูุงุนุงุช ุฑุง ูุฏุงุฑูุฏ:

1. **`basket_snapshot`**: ุงุทูุงุนุงุช ุณุจุฏ ุฎุฑุฏ (ูุญุตููุงุชุ ุชุนุฏุงุฏุ ููุชโูุง)
2. **`leader_paid_at`**: ุฒูุงู ูพุฑุฏุงุฎุช ูุฏุฑ
3. **`expires_at`**: ุฒูุงู ุงููุถุง ฺฏุฑูู (24 ุณุงุนุช ุจุนุฏ ุงุฒ ูพุฑุฏุงุฎุช ูุฏุฑ)

ุจุฏูู ุงู ุงุทูุงุนุงุชุ API ูุง ูุฑุงูุชโุงูุฏ ููโุชูุงููุฏ:
- ุณุจุฏ ุฎุฑุฏ ุฑุง ููุงุด ุฏููุฏ
- ุฒูุงู ุจุงููุงูุฏู ุฑุง ูุญุงุณุจู ฺฉููุฏ
- ููุชโูุง ุฑุง ูุดุงู ุฏููุฏ

## ๐๏ธ ุฑุงู ุญู

### ูุฑุญูู 1: ุจุฑุฑุณ ูุถุนุช ูุนู

ุงุจุชุฏุง ุงุณฺฉุฑูพุช debug ุฑุง ุงุฌุฑุง ฺฉูุฏ ุชุง ุจุจูุฏ ฺฉุฏุงู ฺฏุฑููโูุง ูุดฺฉู ุฏุงุฑูุฏ:

```bash
cd C:\Projects\final_bahamm
python debug_group_api.py
```

ุงู ุงุณฺฉุฑูพุช:
- ูุณุช ฺฏุฑููโูุง ุฎุฑุฏ ุฑุง ุงุฒ ุจฺฉโุงูุฏ ูโฺฏุฑุฏ
- ุฌุฒุฆุงุช ฺฉ ฺฏุฑูู ุฎุงุต ุฑุง ฺฺฉ ูโฺฉูุฏ
- API ูุง ูุฑุงูุชโุงูุฏ ุฑุง ุชุณุช ูโฺฉูุฏ

### ูุฑุญูู 2: ุชุนูุฑ ุฏุชุงุจุณ

ุงุณฺฉุฑูพุช ุชุนูุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:

```bash
python fix_basket_snapshot.py
```

ุงู ุงุณฺฉุฑูพุช:
1. **ฺฺฉ ูโฺฉูุฏ** ฺฉุฏุงู ฺฏุฑููโูุง `basket_snapshot` ูุฏุงุฑูุฏ
2. **ูโูพุฑุณุฏ** ุขุง ูโุฎูุงูุฏ ุขููุง ุฑุง ุชุนูุฑ ฺฉูุฏ
3. **ูพุฑ ูโฺฉูุฏ** `basket_snapshot` ุงุฒ ุฑู order items ูุฏุฑ
4. **Set ูโฺฉูุฏ** `leader_paid_at` ู `expires_at` ุงฺฏุฑ null ุจุงุดูุฏ

**ูฺฉุชู ููู**: ุงู ุงุณฺฉุฑูพุช ููุท ฺฏุฑููโูุง ุฑุง ุชุนูุฑ ูโฺฉูุฏ ฺฉู:
- `basket_snapshot` ูุฏุงุฑูุฏ ุง ุฎุงู ุงุณุช
- ุญุฏุงูู ฺฉ order ุฏุงุฑูุฏ

### ูุฑุญูู 3: ุชุณุช

ุจุนุฏ ุงุฒ ุงุฌุฑุง ุงุณฺฉุฑูพุช ุชุนูุฑ:

1. **ุจุฑุฑุณ ูุถุนุช ุฌุฏุฏ**:
   ```bash
   python debug_group_api.py
   ```

2. **ุชุณุช ุฏุฑ ูุฑูุฑฺฏุฑ**:
   - ุตูุญู landingM: `http://localhost:3000/landingM?invite={invite_code}`
   - ุตูุญู track: `http://localhost:3000/track/{group_id}`
   - ุตูุญู invite: `http://localhost:3000/invite?authority={authority}`

## ๐ ุจุฑุฑุณ ุฏุณุช

ุงฺฏุฑ ูโุฎูุงูุฏ ุฏุณุช ฺฉ ฺฏุฑูู ุฎุงุต ุฑุง ฺฺฉ ฺฉูุฏ:

### 1. ุงุฒ ุทุฑู Browser DevTools

ุจุงุฒ ฺฉูุฏ: `http://localhost:3000/api/groups/{group_id}`

ฺุฒูุง ฺฉู ุจุงุฏ ฺฺฉ ฺฉูุฏ:
```json
{
  "id": "140",
  "basket": [  // ุจุงุฏ ูพุฑ ุจุงุดุฏ
    {
      "productId": "3",
      "name": "ุณุจ ุฒูู",
      "qty": 1,
      "unitPrice": 3500
    }
  ],
  "pricing": {
    "originalTotal": 9500,  // ุจุงุฏ ุจุฒุฑฺฏุชุฑ ุงุฒ 0 ุจุงุดุฏ
    "currentTotal": 9500
  },
  "expiresAtMs": 1234567890000,  // ุจุงุฏ ุนุฏุฏ ุจุงุดุฏุ ูู null
  "remainingSeconds": 12345,  // ุจุงุฏ ุจุฒุฑฺฏุชุฑ ุงุฒ 0 ุจุงุดุฏ
  "serverNowMs": 1234567890000
}
```

### 2. ูุณุชูู ุงุฒ ุฏุชุงุจุณ

```python
from app.database import get_db
from app.models import GroupOrder
import json

db = next(get_db())

# ฺฺฉ ฺฉุฑุฏู ฺฉ ฺฏุฑูู ุฎุงุต
group = db.query(GroupOrder).filter(GroupOrder.id == 140).first()

print(f"ID: {group.id}")
print(f"basket_snapshot: {group.basket_snapshot}")
print(f"leader_paid_at: {group.leader_paid_at}")
print(f"expires_at: {group.expires_at}")

if group.basket_snapshot:
    data = json.loads(group.basket_snapshot)
    print(f"ุชุนุฏุงุฏ ุขุชูโูุง: {len(data.get('items', []))}")
```

## ๐จ ูุดฺฉูุงุช ุงุญุชูุงู ู ุฑุงู ุญู

### ูุดฺฉู 1: ุฒูุงู ุจุงููุงูุฏู 0 ุงุณุช

**ุนูุช**: `expires_at` null ุงุณุช ุง ฺฏุฐุดุชู ุงุณุช

**ุฑุงู ุญู**:
```python
from app.database import get_db
from app.models import GroupOrder
from datetime import datetime, timedelta, timezone

TEHRAN_TZ = timezone(timedelta(hours=3, minutes=30))
db = next(get_db())

group = db.query(GroupOrder).filter(GroupOrder.id == YOUR_GROUP_ID).first()

# ุงฺฏุฑ leader_paid_at ุฏุงุฑุฏ
if group.leader_paid_at:
    group.expires_at = group.leader_paid_at + timedelta(hours=24)
else:
    # ุง ุงุฒ created_at ุงุณุชูุงุฏู ฺฉูุฏ
    group.expires_at = group.created_at + timedelta(hours=24)

db.commit()
```

### ูุดฺฉู 2: ุณุจุฏ ุฎุงู ุงุณุช

**ุนูุช**: `basket_snapshot` null ุง ุฎุงู ุงุณุช

**ุฑุงู ุญู**: ุงุฌุฑุง `fix_basket_snapshot.py`

### ูุดฺฉู 3: ููุชโูุง 0 ูุณุชูุฏ

**ุนูุช**: ูุญุตููุงุช ููุช `friend_1_price`, `friend_2_price`, `friend_3_price` ูุฏุงุฑูุฏ

**ุฑุงู ุญู**: ุฏุฑ ูพูู ุงุฏููุ ููุชโูุง ูุญุตููุงุช ุฑุง set ฺฉูุฏ

## ๐ ฺฺฉ ูุณุช ุชุงุฏ

ุจุนุฏ ุงุฒ ุงุฌุฑุง ุงุณฺฉุฑูพุช ุชุนูุฑุ ุงู ููุงุฑุฏ ุฑุง ฺฺฉ ฺฉูุฏ:

- [ ] API `/api/groups/{group_id}` basket ูพุฑ ุจุฑูโฺฏุฑุฏุงูุฏ
- [ ] API `/api/groups/{group_id}` expiresAtMs ุนุฏุฏ ุจุฑูโฺฏุฑุฏุงูุฏ (ูู null)
- [ ] API `/api/groups/{group_id}` remainingSeconds ุจุฒุฑฺฏุชุฑ ุงุฒ 0 ุงุณุช (ุงฺฏุฑ expire ูุดุฏู)
- [ ] ุตูุญู landingM ุณุจุฏ ุฑุง ูุดุงู ูโุฏูุฏ
- [ ] ุตูุญู landingM ุฒูุงู ุจุงููุงูุฏู ุฑุง ูุดุงู ูโุฏูุฏ
- [ ] ุตูุญู track ุงุทูุงุนุงุช ฺฉุงูู ุฑุง ูุดุงู ูโุฏูุฏ
- [ ] ุตูุญู invite ุชุงูุฑ ฺฉุงุฑ ูโฺฉูุฏ

## ๐ ูพุดฺฏุฑ ุงุฒ ูุดฺฉู ุฏุฑ ุขูุฏู

ุจุฑุง ุงูฺฉู ุงู ูุดฺฉู ุฏูุจุงุฑู ูพุด ูุงุฏ:

1. **ููุดู `basket_snapshot` ุฑุง set ฺฉูุฏ** ููฺฏุงู ุงุฌุงุฏ GroupOrder
2. **ููุดู `leader_paid_at` ุฑุง set ฺฉูุฏ** ููฺฏุงู ููููุช ูพุฑุฏุงุฎุช
3. **ููุดู `expires_at` ุฑุง ูุญุงุณุจู ฺฉูุฏ**: `leader_paid_at + 24 hours`

ุงู ฺฉุงุฑูุง ุฏุฑ ุงู ูุงูโูุง ุงูุฌุงู ูโุดููุฏ:
- `backend/app/routes/payment.py` (ุชุงุจุน `verify_payment`)
- `backend/app/services/payment_service.py` (ุชุงุจุน `verify_payment`)
- `backend/app/routes/groups_routes.py` (ุชุงุจุน `create_secondary_group`)

## ๐ ุฏุฑ ุตูุฑุช ูุงุฒ ุจู ฺฉูฺฉ

ุงฺฏุฑ ุจุนุฏ ุงุฒ ุงุฌุฑุง ุงู ูุฑุงุญูุ ูุดฺฉู ุญู ูุดุฏ:

1. ุฎุฑูุฌ `debug_group_api.py` ุฑุง ุฐุฎุฑู ฺฉูุฏ
2. ฺฉ ฺฏุฑูู ุฎุงุต ฺฉู ูุดฺฉู ุฏุงุฑุฏ ุฑุง ูุดุฎุต ฺฉูุฏ (ุจุง ID)
3. ุงุฒ ุฏุชุงุจุณุ ุงุทูุงุนุงุช ุขู ฺฏุฑูู ุฑุง export ฺฉูุฏ:
   ```sql
   SELECT * FROM group_orders WHERE id = YOUR_GROUP_ID;
   SELECT * FROM orders WHERE group_order_id = YOUR_GROUP_ID;
   ```

---

**ุชุงุฑุฎ ุงุฌุงุฏ**: 2025-01-14
**ูุณุฎู**: 1.0

