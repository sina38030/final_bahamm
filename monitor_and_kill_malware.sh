#!/bin/bash
# Continuous malware monitoring and auto-kill script
# This will monitor for crypto miners and automatically kill them

LOG_FILE="/var/log/malware_monitor.log"

echo "========================================" | sudo tee -a $LOG_FILE
echo "Malware Monitor Started: $(date)" | sudo tee -a $LOG_FILE
echo "========================================" | sudo tee -a $LOG_FILE

while true; do
    # Check for processes in /dev/shm
    MALWARE_PIDS=$(ps aux | grep '/dev/shm/' | grep -v grep | awk '{print $2}')
    
    if [ ! -z "$MALWARE_PIDS" ]; then
        echo "[$(date)] ALERT: Malware detected in /dev/shm!" | sudo tee -a $LOG_FILE
        ps aux | grep '/dev/shm/' | grep -v grep | sudo tee -a $LOG_FILE
        
        for PID in $MALWARE_PIDS; do
            echo "[$(date)] Killing PID: $PID" | sudo tee -a $LOG_FILE
            sudo kill -9 $PID
        done
        
        # Remove all files from /dev/shm
        echo "[$(date)] Cleaning /dev/shm..." | sudo tee -a $LOG_FILE
        sudo rm -rf /dev/shm/*
        echo "[$(date)] /dev/shm cleaned!" | sudo tee -a $LOG_FILE
    fi
    
    # Check for high CPU processes (>50%)
    HIGH_CPU=$(ps aux --sort=-%cpu | awk 'NR>1 && $3>50 {print $2,$3,$11}')
    if [ ! -z "$HIGH_CPU" ]; then
        echo "[$(date)] High CPU detected:" | sudo tee -a $LOG_FILE
        echo "$HIGH_CPU" | sudo tee -a $LOG_FILE
    fi
    
    # Check for suspicious process names
    SUSPICIOUS=$(ps aux | grep -iE 'xmrig|minerd|cpuminer|cryptonight|kdevtmpfsi|kinsing' | grep -v grep)
    if [ ! -z "$SUSPICIOUS" ]; then
        echo "[$(date)] ALERT: Suspicious process detected!" | sudo tee -a $LOG_FILE
        echo "$SUSPICIOUS" | sudo tee -a $LOG_FILE
        
        SUSP_PIDS=$(echo "$SUSPICIOUS" | awk '{print $2}')
        for PID in $SUSP_PIDS; do
            echo "[$(date)] Killing suspicious PID: $PID" | sudo tee -a $LOG_FILE
            sudo kill -9 $PID
        done
    fi
    
    # Sleep for 30 seconds before next check
    sleep 30
done













