# âœ… Payment Callback Ø¨Ù‡ Ø³Ø§ÛŒØª bahamm.ir ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯

## ğŸ”§ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡

### 1ï¸âƒ£ Redirect Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ú©Ø§Ø±Ø¨Ø±

Ù¾Ø±Ø¯Ø§Ø®Øª callback Ø­Ø§Ù„Ø§ **Ø¨Ù‡ Ø³Ø§ÛŒØª bahamm.ir Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ù‡** (Ù†Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…!)ØŒ Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯Ø§Ù†Ù‡ redirect Ù…ÛŒâ€ŒÚ©Ù†Ù‡:

#### ğŸ¯ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù:

| Ù†ÙˆØ¹ Ú©Ø§Ø±Ø¨Ø± | Ø´Ø±Ø· | Redirect Ø¨Ù‡ |
|-----------|------|-------------|
| **Ù„ÛŒØ¯Ø± Ú¯Ø±ÙˆÙ‡** | `order_type=GROUP` Ùˆ `group_order_id=NULL` | `/invite?authority=XXX` |
| **Ú©Ø§Ø±Ø¨Ø± Invited** | `group_order_id != NULL` | `/orders` |
| **Ø®Ø±ÛŒØ¯ Solo** | `order_type=ALONE` | `/successpayment?authority=XXX` |
| **Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚** | `Status != OK` | `/cart?payment_failed=true` |
| **Ø®Ø·Ø§** | Exception | `/cart?payment_error=true` |

### 2ï¸âƒ£ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡

#### `backend/app/routes/payment.py` (Ø®Ø·ÙˆØ· 624-693)
- ØªØ§Ø¨Ø¹ `payment_callback` Ø±Ùˆ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ø±Ø¯ÛŒÙ…
- **Ù‚Ø¨Ù„**: Ù‡Ù…Ù‡ Ø¨Ù‡ `t.me/Bahamm_bot/bahamm` Ù…ÛŒâ€ŒØ±ÙØªÙ† ğŸš«
- **Ø­Ø§Ù„Ø§**: Ø¨Ø±Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ order Ø¨Ù‡ ØµÙØ­Ø§Øª Ù…Ù†Ø§Ø³Ø¨ redirect Ù…ÛŒâ€ŒØ´Ù† âœ…

#### `backend/app/services/payment_service.py` (Ø®Ø· 890)
- callback URL Ø±Ùˆ Ø§Ø² `/payment/callback` Ø¨Ù‡ `/api/payment/callback` ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯ÛŒÙ…

### 3ï¸âƒ£ Ù…Ù†Ø·Ù‚ ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ú©Ø§Ø±Ø¨Ø±

```python
# Leader: Ú©Ø³ÛŒ Ú©Ù‡ Ú¯Ø±ÙˆÙ‡ Ø±Ùˆ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù‡
is_leader = (order.order_type == OrderType.GROUP and order.group_order_id is None)

# Invited/Solo: Ú©Ø³ÛŒ Ú©Ù‡ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ join Ù…ÛŒâ€ŒÚ©Ù†Ù‡ ÛŒØ§ solo Ø®Ø±ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù‡  
is_invited_or_solo = (order.group_order_id is not None or order.order_type == OrderType.ALONE)
```

## ğŸ¯ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª

### Ù…Ø«Ø§Ù„ 1: Ù„ÛŒØ¯Ø± Ú¯Ø±ÙˆÙ‡
```
Ú©Ø§Ø±Ø¨Ø± (Ù„ÛŒØ¯Ø±) checkout Ù…ÛŒâ€ŒÚ©Ù†Ù‡
  â†“
Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª
  â†“
https://bahamm.ir/api/payment/callback?Authority=A000...&Status=OK
  â†“
Backend: order.group_order_id = NULL âœ Ù„ÛŒØ¯Ø± Ù‡Ø³Øª!
  â†“
https://bahamm.ir/invite?authority=A000... âœ…
```

### Ù…Ø«Ø§Ù„ 2: Ú©Ø§Ø±Ø¨Ø± Invited
```
Ú©Ø§Ø±Ø¨Ø± (invited) Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ join Ù…ÛŒâ€ŒÚ©Ù†Ù‡
  â†“
Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª
  â†“
https://bahamm.ir/api/payment/callback?Authority=A000...&Status=OK
  â†“
Backend: order.group_order_id = 123 âœ invited Ù‡Ø³Øª!
  â†“
https://bahamm.ir/orders âœ…
(Ø¯Ø± Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¯Ú©Ù…Ù‡ "Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒØª Ø±Ùˆ Ù¾Ø³ Ø¨Ú¯ÛŒØ±!" Ø¨Ø§ timer Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
```

### Ù…Ø«Ø§Ù„ 3: Ø®Ø±ÛŒØ¯ Solo
```
Ú©Ø§Ø±Ø¨Ø± solo Ø®Ø±ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù‡
  â†“
Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª
  â†“
https://bahamm.ir/api/payment/callback?Authority=A000...&Status=OK
  â†“
Backend: order.order_type = ALONE âœ solo Ù‡Ø³Øª!
  â†“
https://bahamm.ir/successpayment?authority=A000... âœ…
```

## ğŸ“ Ù†Ú©Ø§Øª Ù…Ù‡Ù…

1. **Ø¯ÛŒÚ¯Ù‡ Ù‡ÛŒÚ† redirect Ø§ÛŒ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ù†Ø¯Ø§Ø±ÛŒÙ…** - Ù‡Ù…Ù‡ Ø¨Ù‡ bahamm.ir Ù…ÛŒâ€ŒØ±Ù†
2. **Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯** - Ø¨Ø±Ø§ÛŒ debug Ú©Ø±Ø¯Ù† Ù…Ø´Ú©Ù„Ø§Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ
3. **Fallback Ù…Ù†Ø§Ø³Ø¨** - Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯ØŒ Ø¨Ù‡ `/invite` ÛŒØ§ `/cart` Ù…ÛŒâ€ŒØ±Ù‡
4. **Invite code** Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± invited Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´Ù‡ ØªØ§ Ø¨ØªÙˆÙ†Ù‡ Ú¯Ø±ÙˆÙ‡ Ø±Ùˆ Ø¨Ø¨ÛŒÙ†Ù‡

## ğŸ§ª ØªØ³Øª Ú©Ø±Ø¯Ù†

Ø¨Ø±Ø§ÛŒ ØªØ³Øª:

1. **Ù„ÛŒØ¯Ø± Ú¯Ø±ÙˆÙ‡**:
   - Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ Ø³Ø¨Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
   - "Ø®Ø±ÛŒØ¯ Ú¯Ø±ÙˆÙ‡ÛŒ" Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
   - checkout Ú©Ù†
   - Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø±ÛŒ `/invite` âœ“

2. **Ú©Ø§Ø±Ø¨Ø± Invited**:
   - Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ú©Ù„ÛŒÚ© Ú©Ù†
   - Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
   - Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø±ÛŒ `/orders` âœ“
   - Ø¯Ø± Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¯Ú©Ù…Ù‡ "Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒØª Ø±Ùˆ Ù¾Ø³ Ø¨Ú¯ÛŒØ±!" Ø¨Ø§ timer Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

3. **Ø®Ø±ÛŒØ¯ Solo**:
   - Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ Ø³Ø¨Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
   - "Ø®Ø±ÛŒØ¯ ØªÚ©ÛŒ" Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
   - checkout Ú©Ù†
   - Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø±ÛŒ `/successpayment` âœ“

## âœ… Ù…Ø´Ú©Ù„ Ø­Ù„ Ø´Ø¯Ù‡!

Ø¯ÛŒÚ¯Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§ Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… redirect Ù†Ù…ÛŒâ€ŒØ´Ù†! Ù‡Ù…Ù‡ Ø¨Ù‡ Ø³Ø§ÛŒØª bahamm.ir Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ù†. ğŸ‰

