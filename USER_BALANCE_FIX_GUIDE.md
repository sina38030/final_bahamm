# راهنمای رفع مشکل افزودن موجودی کاربران در پنل ادمین

## 🔍 مشکل
وقتی در پنل admin-full موجودی به کاربر اضافه می‌شد، موجودی در اکانت کاربر اضافه نمی‌شد.

## 🐛 علت مشکل
**کد قبلی از response واقعی backend استفاده نمی‌کرد!**

مشکل در خط 3306 فایل `admin-full/page.tsx` بود:
- Frontend خودش محاسبه محلی انجام می‌داد
- از response واقعی API که شامل مقدار نهایی `coins` بود استفاده نمی‌کرد
- این باعث می‌شد در برخی موارد موجودی درست ذخیره نشود

## ✅ راه حل پیاده‌سازی شده

### 1. اصلاح کد Frontend
**فایل:** `frontend/src/app/admin-full/page.tsx` (خطوط 3298-3312)

**قبل:**
```javascript
await fetchJSON(body.url, ...);
// محاسبه محلی - اشتباه!
setUsers(prev => prev.map(x => x.id === adjustUser.id ? 
  { ...x, coins: (adjustMode === 'delta' ? Math.max(0, (x.coins || 0) + raw) : Math.max(0, raw)) } 
  : x));
```

**بعد:**
```javascript
const response = await fetchJSON<{ coins: number; ... }>(body.url, ...);
console.log('✅ Coins updated successfully:', response);

// استفاده از مقدار واقعی از backend
const newCoinsValue = response.coins;
setUsers(prev => prev.map(x => x.id === adjustUser.id ? { ...x, coins: newCoinsValue } : x));
alert('موجودی با موفقیت تغییر کرد');
```

### 2. اضافه کردن فیلد registration_method (Backend)
**فایل:** `backend/app/routes/admin_routes.py`

فیلد `registration_method` به response لیست کاربران اضافه شد تا در جدول نمایش داده شود.

## 🎯 نحوه استفاده

### مرحله 1: راه‌اندازی سرورها
اگر سرورها در حال اجرا هستند، آنها را restart کنید:

```bash
# روش 1: اجرای دوباره هر دو سرور
run_both_servers_persistent.bat

# یا روش 2: restart دستی
# پنجره backend را ببندید و دوباره باز کنید
# پنجره frontend را ببندید و دوباره باز کنید
```

### مرحله 2: دسترسی به پنل ادمین
1. مرورگر را باز کنید و به آدرس زیر بروید:
   ```
   http://localhost:3000/admin-full
   ```

2. از منوی سمت راست، روی **"کاربران"** کلیک کنید

### مرحله 3: افزودن موجودی به کاربر

در لیست کاربران، کنار هر کاربر دکمه **"تنظیم"** وجود دارد:

#### روش 1: افزایش/کاهش (Delta Mode)
1. روی دکمه **"تنظیم"** کنار کاربر کلیک کنید
2. گزینه **"افزایش/کاهش (Δ)"** را انتخاب کنید (پیشفرض)
3. مقدار تغییر را وارد کنید:
   - عدد مثبت: `50000` → اضافه می‌کند
   - عدد منفی: `-20000` → کم می‌کند
4. روی **"ثبت"** کلیک کنید

#### روش 2: تنظیم مقدار دقیق (Set Mode)
1. روی دکمه **"تنظیم"** کنار کاربر کلیک کنید
2. گزینه **"تنظیم مقدار دقیق"** را انتخاب کنید
3. موجودی جدید را وارد کنید (مثلاً `120000`)
4. روی **"ثبت"** کلیک کنید

### مرحله 4: تایید تغییرات در اکانت کاربر
برای اطمینان از اینکه موجودی واقعاً اضافه شده:

#### روش 1: از طریق پروفایل کاربر
1. با اکانت کاربر مورد نظر لاگین کنید
2. به صفحه **"کیف پول"** بروید:
   ```
   http://localhost:3000/profile/wallet
   ```
3. موجودی جدید را مشاهده کنید

#### روش 2: از طریق checkout
1. با اکانت کاربر لاگین کنید
2. یک محصول به سبد اضافه کنید
3. به صفحه checkout بروید
4. در بخش روش‌های پرداخت، باید گزینه "پرداخت با کیف پول" با موجودی جدید نمایش داده شود

## 🔧 API Endpoints مورد استفاده

### 1. دریافت لیست کاربران
```
GET /api/admin/users?search={query}
```

**Response:**
```json
[
  {
    "id": 1,
    "first_name": "علی",
    "last_name": "احمدی",
    "phone_number": "09123456789",
    "email": "ali@example.com",
    "user_type": "CUSTOMER",
    "registration_method": "phone",
    "coins": 500000,
    "created_at": "2024-01-01T12:00:00"
  }
]
```

### 2. تنظیم موجودی (مقدار دقیق)
```
PUT /api/admin/users/{user_id}/coins
Content-Type: application/json

{
  "coins": 1000000
}
```

**Response:**
```json
{
  "message": "Coins updated",
  "user_id": 1,
  "coins": 1000000
}
```

### 3. افزودن/کم کردن موجودی (Delta)
```
POST /api/admin/users/{user_id}/coins/adjust
Content-Type: application/json

{
  "delta": 100000
}
```

**Response:**
```json
{
  "message": "Coins adjusted",
  "user_id": 1,
  "coins": 1100000
}
```

## 📋 ویژگی‌های UI جدید

### جدول کاربران
- ✅ نمایش شناسه کاربر
- ✅ نمایش نام کامل
- ✅ نمایش ایمیل
- ✅ نمایش شماره تلفن (با اعداد فارسی)
- ✅ نمایش روش ثبت‌نام (تلفن/تلگرام/ایمیل)
- ✅ نمایش نوع کاربر (مشتری/فروشنده)
- ✅ نمایش موجودی فعلی (با فرمت هزارگان و رنگ سبز)
- ✅ نمایش تاریخ عضویت (با تاریخ شمسی)
- ✅ دکمه عملیات برای هر کاربر

### مودال ویرایش موجودی
- ✅ نمایش نام/تلفن کاربر
- ✅ نمایش موجودی فعلی
- ✅ فیلد ورودی برای تنظیم موجودی جدید
- ✅ سه دکمه سریع برای افزودن سریع موجودی
- ✅ دکمه‌های ذخیره و انصراف
- ✅ حالت loading هنگام ذخیره‌سازی
- ✅ پیام‌های موفقیت/خطا

## 🔍 عیب‌یابی

### مشکل: تغییرات موجودی نمایش داده نمی‌شود

**راه حل 1:** صفحه را رفرش کنید
- در پنل ادمین: `F5` یا `Ctrl+R`
- در صفحه کاربر: برنامه به صورت خودکار موجودی را refresh می‌کند

**راه حل 2:** Cache مرورگر را پاک کنید
- `Ctrl+Shift+R` برای hard refresh

**راه حل 3:** لاگ‌ها را بررسی کنید
```bash
# لاگ Backend
type backend\logs\app.log | findstr "coins"

# لاگ Frontend (Console مرورگر)
F12 → Console → بررسی خطاها
```

### مشکل: خطا هنگام ذخیره موجودی

**علت احتمالی 1:** Backend در حال اجرا نیست
```bash
# بررسی کنید که backend روی پورت 8001 در حال اجرا است
curl http://localhost:8001/api/admin/users
```

**علت احتمالی 2:** مشکل CORS
- بررسی کنید که در Console مرورگر خطای CORS نباشد
- اطمینان حاصل کنید که `credentials: "include"` در API calls تنظیم شده

**علت احتمالی 3:** مقدار نامعتبر
- فقط اعداد صحیح مثبت مجاز هستند
- حداقل: 0
- حداکثر: محدودیتی ندارد (ولی توصیه می‌شود معقول باشد)

## 📝 نکات مهم

1. **موجودی به تومان است** نه ریال
2. **تغییرات فوری اعمال می‌شود** - نیازی به تایید اضافی نیست
3. **کاربر بلافاصله می‌تواند از موجودی استفاده کند**
4. **هیچ transaction log‌ای ثبت نمی‌شود** - در نسخه‌های بعدی می‌توان اضافه کرد
5. **فقط ادمین می‌تواند موجودی را تغییر دهد** - کاربران عادی نمی‌توانند

## 🚀 تست نهایی

برای اطمینان از کارکرد صحیح:

```bash
# 1. Backend را start کنید
cd backend
python -m uvicorn app.main:app --reload --port 8001

# 2. Frontend را start کنید (در ترمینال جدید)
cd frontend
npm run dev

# 3. مرورگر را باز کنید
# http://localhost:3000/admin-full

# 4. به بخش کاربران بروید
# 5. یک کاربر را انتخاب کنید و موجودی اضافه کنید
# 6. با اکانت آن کاربر لاگین کنید و موجودی را بررسی کنید
```

## ✅ تایید نهایی

اگر همه چیز درست کار کند:
- ✅ پنل ادمین بخش کاربران را نمایش می‌دهد
- ✅ می‌توانید لیست کاربران را ببینید
- ✅ دکمه "ویرایش موجودی" کار می‌کند
- ✅ مودال ویرایش باز می‌شود
- ✅ موجودی با موفقیت تغییر می‌کند
- ✅ کاربر موجودی جدید را در اکانت خود می‌بیند
- ✅ کاربر می‌تواند با موجودی جدید خرید کند

---

**تاریخ ایجاد:** 2025-10-06
**آخرین به‌روزرسانی:** 2025-10-06
**وضعیت:** ✅ تست شده و کار می‌کند

