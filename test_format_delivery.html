<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Delivery Slot Formatting</title>
    <style>
        body { font-family: Tahoma, Arial; padding: 20px; background: #f5f5f5; }
        .test-case { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input { color: #666; font-size: 12px; margin-bottom: 8px; }
        .output { font-size: 14px; font-weight: bold; color: #2c5aa0; }
        h1 { color: #333; }
    </style>
</head>
<body>
    <h1>تست فرمت زمان تحویل</h1>
    <div id="results"></div>

    <script>
        const DIGIT_NORMALIZATION_MAP = {
          '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4', '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9',
          '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4', '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
          '٬': '', ',': '', '　': '', ' ': '', '٫': '.'
        };

        const PERSIAN_DATE_FORMAT_OPTIONS = {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          year: 'numeric',
        };

        let cachedLatinPersianDateFormatter;
        let cachedPersianDateFormatter;

        function createPersianDateFormatter(locale) {
          if (typeof Intl === 'undefined') return null;
          try {
            return new Intl.DateTimeFormat(locale, PERSIAN_DATE_FORMAT_OPTIONS);
          } catch {
            return null;
          }
        }

        function formatPersianDateWithWeekday(date) {
          if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
          if (cachedLatinPersianDateFormatter === undefined) {
            cachedLatinPersianDateFormatter = createPersianDateFormatter('fa-IR-u-nu-latn');
          }
          if (cachedPersianDateFormatter === undefined) {
            cachedPersianDateFormatter = createPersianDateFormatter('fa-IR');
          }
          const formatter = cachedLatinPersianDateFormatter || cachedPersianDateFormatter;
          if (formatter) {
            try {
              return formatter.format(date).replace(/\u200f/g, '').trim();
            } catch {}
          }
          try {
            return date.toLocaleDateString('fa-IR', PERSIAN_DATE_FORMAT_OPTIONS);
          } catch {
            try {
              return date.toLocaleDateString('fa-IR');
            } catch {
              return date.toDateString();
            }
          }
        }

        function normalizeTimeToken(value) {
          if (value === null || value === undefined) return '';
          const raw = String(value).trim();
          if (!raw) return '';
          const withLatinDigits = raw.replace(/[۰-۹٠-٩]/g, (ch) => DIGIT_NORMALIZATION_MAP[ch] ?? ch);
          const cleaned = withLatinDigits.replace(/\s+/g, ' ').replace(/ساعت\s*/gi, '').trim();
          const normalized = cleaned.replace(/\s*:\s*/g, ':');
          const explicitMatch = normalized.match(/(\d{1,2}(?::\d{2})?)/);
          if (explicitMatch) return explicitMatch[1];
          const digitsOnly = normalized.replace(/\D/g, '');
          if (!digitsOnly) return '';
          if (digitsOnly.length === 3) {
            return `${digitsOnly.slice(0, 1)}:${digitsOnly.slice(1)}`;
          }
          if (digitsOnly.length >= 4) {
            return `${digitsOnly.slice(0, digitsOnly.length - 2)}:${digitsOnly.slice(-2)}`;
          }
          return digitsOnly;
        }

        function buildSlotDisplay(date, from, to, rawDateLabel) {
          const datePart = date && !Number.isNaN(date.getTime())
            ? formatPersianDateWithWeekday(date)
            : (rawDateLabel ? String(rawDateLabel).trim() : '');
          const fromPart = normalizeTimeToken(from);
          const toPart = normalizeTimeToken(to);
          const hasTime = Boolean(fromPart || toPart);
          if (datePart && hasTime) {
            const range = fromPart && toPart ? `${fromPart} تا ${toPart}` : (fromPart || toPart);
            return `${datePart},ساعت ${range}`;
          }
          if (datePart) return datePart;
          if (hasTime) {
            const range = fromPart && toPart ? `${fromPart} تا ${toPart}` : (fromPart || toPart);
            return `ساعت ${range}`;
          }
          return '';
        }

        function formatDeliverySlot(raw) {
          try {
            if (!raw) return "";
            let slot = raw;
            
            // If JSON-encoded, parse and extract nested delivery_slot or window
            if (typeof slot === 'string') {
              const trimmed = slot.trim();
              if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                try {
                  const obj = JSON.parse(trimmed);
                  if (obj && typeof obj === 'object') {
                    // First check if there's a nested delivery_slot field
                    if (typeof obj.delivery_slot === 'string' && obj.delivery_slot.trim().length > 0) {
                      // Recursively call to handle the inner delivery_slot value
                      return formatDeliverySlot(obj.delivery_slot);
                    } else if (obj.date && (obj.from || obj.to)) {
                      // Handle structured date/time object
                      const d = new Date(String(obj.date));
                      const formatted = buildSlotDisplay(d, obj.from, obj.to, obj.date);
                      if (formatted) return formatted;
                    }
                  }
                } catch (e) {
                  console.error('JSON parse error:', e);
                }
              }
            }
            
            if (typeof slot !== 'string') slot = String(slot ?? '');
            const s = slot.trim();
            if (!s) return '';
            
            // Replace relative terms like 'فردا' with explicit date
            if (/^فردا(\s|$)/.test(s)) {
              const now = new Date();
              const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
              const times = s.replace(/^فردا\s*/, '').trim();
              if (times) {
                const m = times.match(/(\d{1,2}(?::\d{2})?)(?:\s*(?:-|تا)\s*(\d{1,2}(?::\d{2})?))?/);
                if (m) {
                  const formatted = buildSlotDisplay(tomorrow, m[1], m[2]);
                  if (formatted) return formatted;
                }
              }
              const formatted = buildSlotDisplay(tomorrow);
              if (formatted) return formatted;
            }
            
            // Try patterns like: YYYY-MM-DD HH:mm-HH:mm or with 'T'
            const m = s.match(/^(\d{4}-\d{2}-\d{2})(?:[ T](\d{1,2}:\d{2}))?(?:\s*(?:-|تا)\s*(\d{1,2}:\d{2}))?$/);
            if (m) {
              const d = new Date(`${m[1]}T00:00:00`);
              const formatted = buildSlotDisplay(d, m[2], m[3], m[1]);
              if (formatted) return formatted;
            }
            
            const parsedDate = Date.parse(s);
            if (!Number.isNaN(parsedDate)) {
              const formatted = buildSlotDisplay(new Date(parsedDate), undefined, undefined, s);
              if (formatted) return formatted;
            }
            
            return s;
          } catch (e) {
            console.error('formatDeliverySlot error:', e);
            return String(raw ?? '');
          }
        }

        // Test cases based on real database data
        const testCases = [
            '{"mode": "group"}',
            '{"delivery_slot": "پس فردا ۱۲ تا ۱۴", "mode": "group"}',
            '{"delivery_slot": "فردا 15 تا 18", "mode": "group"}',
            'فردا 12 تا 14',
            '2025-01-15 14:00-16:00',
            '2025-01-15',
            'پس فردا ۱۵ تا ۱۸'
        ];

        const resultsDiv = document.getElementById('results');
        
        testCases.forEach((testCase, index) => {
            const result = formatDeliverySlot(testCase);
            const div = document.createElement('div');
            div.className = 'test-case';
            div.innerHTML = `
                <div class="input">ورودی ${index + 1}: <code>${testCase}</code></div>
                <div class="output">خروجی: ${result || '(خالی)'}</div>
            `;
            resultsDiv.appendChild(div);
            
            console.log(`Test ${index + 1}:`);
            console.log('  Input:', testCase);
            console.log('  Output:', result);
        });
    </script>
</body>
</html>






